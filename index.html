<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Teste Rafael Maruta - Front-End Recruitment</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/netshoes.min.css" />
	<script src="js/zepto.min.js"></script>
	<script src="js/bower_components/react/react.min.js"></script>
	<script src="js/bower_components/react/react-dom.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.min.js"></script>
</head>
<body class="col-xs-12">
	<div class="row center-xs">
		<div id="container"></div>
	</div>

	<script type="text/babel">
	/*var React = require('react');
	var ReactDOM = require('react-dom');*/

	var config = {
		currencyFormat    : 'R$',
		dir_content       : 'content/',
		url_json          : 'data/products.json',
		url_submit        : '/',
		total_installments: 10
	};

	String.prototype.toSeo = function() {
		var with_accent = 'áàãâäéèêëíìîïóòõôöúùûüçÁÀÃÂÄÉÈÊËÍÌÎÏÓÒÕÖÔÚÙÛÜÇ/',
			no_accent   = 'aaaaaeeeeiiiiooooouuuucAAAAAEEEEIIIIOOOOOUUUUC-',
			new_str     = '';

		for (var i = 0; i < this.length; i++) {
			if (with_accent.search(this.substr(i, 1)) >= 0) {
				new_str += no_accent.substr(with_accent.search(this.substr(i, 1)), 1);
			} else {
				new_str += this.substr(i, 1);
			};
		};
		return new_str.toLowerCase().replace(/ /g, "-");
	};

	var formatPrice = {
		getSplit: function(price) {
			price = price.toFixed(2).toString().split('.');
			return {int: price[0], float: price[1]};
		},
		getInstallments: function(installments, price) {
			return installments > 1 ? (price / installments).toFixed(2).replace('.', ',') : '';
		}
	};

	var ProductsTable = React.createClass({
		getInitialState: function() {
			return {
				cartClass    : [],
				list         : {},
				products     : [],
				productsCart : [],
				totalQuantity: [],
				totalPrice   : 0
			};
		},
		componentDidMount: function() {
			$.getJSON(config.url_json, function(data) {
				this.setState({products: data.products});
				if (localStorage.getItem('productList') !== null) {
					this.storagedProductsCart();
				};
			}.bind(this));
		},
		storagedProductsCart: function() {
			this.setState({list: JSON.parse(localStorage.getItem('productList'))});
			$.each(this.state.list, function(idx, elem) {
				/*this.state.productsCart.push(this.state.products);
				this.setState({products: this.state.products});*/

				var index = this.state.products.findIndex(function(product) {
					return product.id == idx.replace('p-', '');
				});

				this.state.productsCart.push(this.state.products[index]);
				this.setState({products: this.state.products, cartClass: 'open'});
				// Recalculates the total purchase
				this.calcTotal();
			}.bind(this));
		},
		addToCart: function(id) {
			event.preventDefault();
			// Returns the product array index based on its product id
			var index = this.state.products.findIndex(function(product) {
				return product.id == id;
			});
			var product = this.state.products[index];

			if (this.state.productsCart.indexOf(product) == -1) {
				this.state.list['p-' + product.id] = 1;
				this.state.productsCart.push(product);
				this.setState({products: this.state.products});
			} else {
				this.state.list['p-' + product.id]++;
				this.setState({list: this.state.list});
			};
			this.setState({cartClass: 'open'});
			// Recalculates the total purchase
			this.calcTotal();
		},
		removeFromCart: function(id) {
			event.preventDefault();
			// Decreases the product quantity
			this.state.list['p-' + id]--;
			// If the product quantity is equal to zero
			if (this.state.list['p-' + id] == 0) {
				// If the product quantity is equal to zero, removes its array key from the state list
				delete this.state.list['p-' + id];
				// Returns the product array index based on its product id
				var index = this.state.productsCart.findIndex(function(product) {
					return product.id == id;
				});
				// If the product quantity is equal to zero, removes its array key from the product list
				this.state.productsCart.splice(index, 1);
			};
			// Sets the new list state
			this.setState({list: this.state.list});
			// Recalculates the total purchase
			this.calcTotal();
		},
		calcTotal: function() {
			var totalPrice    = 0,
				totalQuantity = 0;

			// Saves the product list in a local storage
			localStorage.setItem('productList', JSON.stringify(this.state.list));

			this.state.productsCart.forEach(function(elem) {
				totalPrice    += elem['price'] * this.state.list['p-' + elem['id']];
				totalQuantity += this.state.list['p-' + elem['id']];
			}.bind(this));

			this.setState({
				totalPrice   : totalPrice,
				totalQuantity: totalQuantity
			});
		},
		submitPurchase: function() {
			event.preventDefault();
			$.post(config.url_submit, {products: this.state.products, list: this.state.list}, function(e) {
				console.log('Submit message:', e);
			});
		},
		cartMouseLeave: function() {
			this.setState({cartClass: 'closed'});
		},
		cartMouseMove: function(e) {
			var tempX = -(e.clientX - $('#products').offset().left - $('#products').width());
			if (tempX <=  30) {
				this.setState({cartClass: 'open'});
			};
		},
		render: function() {
			var productRows = this.state.products.map(function(product) {
	            return (
					<li className="col-md-4 col-sm-6 col-xs-12 center-xs">
		            	<a href="#" title={product.title} onClick={() => this.addToCart(product.id)}>
							<Photo image={config.dir_content + product.title.toSeo() + ".jpg"} title={product.title} description={product.description} />
							<Title title={product.title} description={product.description} separator=" - "/>
							<Price currencyFormat={product.currencyFormat} price={product.price} />
							<Installments text="ou" currencyFormat={product.currencyFormat} price={product.price} installments={product.installments} />
						</a>
					</li>
	            );
			}.bind(this));

			return (
				<div className="shopping">
					<section id="products" className="col-xs-12" onMouseMove={this.cartMouseMove}>
						<ul className="row">
							{productRows}
						</ul>
					</section>
					<aside id="cart" className={this.state.cartClass} onMouseLeave={this.cartMouseLeave}>
						<ProductsCart products={this.state.productsCart} list={this.state.list} totalPrice={this.state.totalPrice} totalQuantity={this.state.totalQuantity} onRemoveFromCart={this.removeFromCart} onSubmitPurchase={this.submitPurchase} />
					</aside>
				</div>
			);
		}
	});

	var Photo = React.createClass({
		render: function() {
			return (
				<figure>
					<img src={this.props.image} alt={this.props.title} />
				</figure>
			);
		}
	});

	var Title = React.createClass({
		render: function() {
			return (
				<h4 className="title">{this.props.title + (this.props.description.trim() !== '' ? this.props.separator : '') + this.props.description}</h4>
			);
		}
	});

	var Price = React.createClass({
		render: function() {
			var price = formatPrice.getSplit(this.props.price);
			return <p className="price">{this.props.currencyFormat} <strong>{price.int}</strong>,{price.float}</p>
		}
	});

	var Installments = React.createClass({
		render: function() {
			if (this.props.installments > 1) {
				var installments = formatPrice.getInstallments(this.props.installments, this.props.price);
				return <p className="installments">{this.props.text} {this.props.installments} x <strong>{this.props.currencyFormat} {installments}</strong></p>
			} else {
				return false;
			};
		}
	});

	var ProductsCart = React.createClass({
		removeFromCart: function(id) {
			this.props.onRemoveFromCart(id);
		},
		render: function() {
			var cartRows = this.props.products.map(function(product) {
	            return (
	            	<CartRow product={product} quantity={this.props.list['p-' + product.id]} onClick={this.removeFromCart} onMouseOver={this.deleteState}/>
	            );
	        }.bind(this));

			return (
				<form className="col-xs-12" role="form" onSubmit={this.props.onSubmitPurchase}>
					<h3 className="cart-title"><span className="bag"><div className="total">{this.props.totalQuantity}</div></span>Sacola</h3>
					<ul>
						{cartRows}
						<CartConclude totalPrice={this.props.totalPrice} />
					</ul>
				</form>
			);
		}
	});

	var CartRow = React.createClass({
		getInitialState: function() {
			return {deleteClass: []};
		},
		removeFromCart: function(id) {
			this.props.onClick(id);
		},
		deleteState: function(className) {
			className = className || '';
			this.setState({deleteClass: className});
		},
		render: function() {
			var product = this.props.product;
			return (
				<li className={"row middle-xs " + this.state.deleteClass}>
					<hr />
					<div className="col-xs-12 col-sm-9 start-sm">
						<Photo image={config.dir_content + product.title.toSeo() + "_thumb.jpg"} title={product.title} description={product.description} />
						<Title title={product.title} description={product.description} separator=" " />
						<CartSize availableSizes={product.availableSizes} style={product.style} />
						<CartQuantity quantity={this.props.quantity} />
					</div>
					<div className="col-xs-12 col-sm-3 end-xs">
						<CartDelete onRemoveFromCart={() => this.removeFromCart(product.id)} onMouseOver={() => this.deleteState('delete')} onMouseOut={this.deleteState} />
						<Price currencyFormat={product.currencyFormat} price={product.price * this.props.quantity} />
					</div>
				</li>
			);
		}
	});

	var CartSize = React.createClass({
		render: function() {
			return (
				<p className="size">{this.props.availableSizes.join(' ')} | {this.props.style}</p>
			);
		}
	});

	var CartQuantity = React.createClass({
		render: function() {
			return (
				<p className="quantity">Quantidade: {this.props.quantity}</p>
			);
		}
	});

	var CartDelete = React.createClass({
		render: function() {
			return (
				<a href="#" className="close ico-cancel33" onClick={this.props.onRemoveFromCart} onMouseOver={this.props.onMouseOver} onMouseOut={this.props.onMouseOut}></a>
			);
		}
	});

	var CartConclude = React.createClass({
		render: function() {
			return (
				<li className="row conclude">
					<hr />
					<p className="subtotal col-xs-12 col-sm-6 start-sm">Subtotal</p>
					<div className="col-xs-12 col-sm-6 end-sm">
						<Price currencyFormat={config.currencyFormat} price={this.props.totalPrice} />
						<Installments text="ou em até" currencyFormat={config.currencyFormat} price={this.props.totalPrice} installments={config.total_installments} />
					</div>
					<CartSubmit />
				</li>
			);
		}
	});

	var CartSubmit = React.createClass({
		render: function() {
			return (
				<div className="col-xs-12 btn-buy-container">
					<input type="submit" className="btn-buy" value="Comprar" />
				</div>
			);
		}
	});
	
	ReactDOM.render(
		<ProductsTable />,
		document.getElementById('container')
	);

	</script>
</body>
</html>